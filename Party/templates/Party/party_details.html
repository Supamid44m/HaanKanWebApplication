{%extends 'Content/components/base.html' %}

{%block title%}{{party.title}}{%endblock%}


{%block content%}

{% if party.isApproved %}
<div style="margin-left: 25%" >
    <div class="border-2 w-64 rounded-md" >
        <h1>รายละเอียดปาร์ตี้</h1>
        
        <div>
            <label for="title">ชื่อ</label>
            <span id="title" name="title">{{party.title}}</span>
        </div>
        <div>
            <label for="title">หัวตี้</label>
            <span id="title" name="title">{{party.owner}}</span>
        </div>
        <div>
            <label for="price">ราคาเต็ม</label>
            <span id="price" name="title">{{party.price}} บาท</span>
        </div>

        
        
        <div class="border-2 w-60 rounded-md ml-2">
            {%if user in party.members.all %}
            <div>
                <a href="{%url 'update' party.id%}">แก้ไข</a>
            </div>
            <div >
                <span>{{party.bank}}</span>
                <span class="ml-16">{{party.bankaccount}}</span>
            </div>
            <div>
                <img src="{{party.qrcodeImage.url}}" alt="image" class="w-64 h-64 ">
            </div>
            <div >
                <span>ชำระภายวันที่</span>
                <span class="ml-16">date</span>
            </div>
           <div>
            
           </div>
            {%else%}
            <div>
                
            </div>
            {%endif%}
        </div>
        <div class="text-center">
            <form method ='POST'  action="{% url 'leave' party.id %}" >
                {% csrf_token %}
            <input type="submit" value="leave" >
            </form>
        </div>

        {%if user == party.owner%}
        <div>
            <h2>สมาชิกที่ขอเข้าร่วม</h2>
            <ul>
               
            {% for user in party.pending_members.all %}
                
                <li>{{ user.username }}</li>
                <form action="{% url 'accept_member' party.id user.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit">Accept</button>
                </form>
                <form action="{% url 'reject_member' party.id user.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit">Reject</button>
                </form>
            {% endfor %}
            </ul>
        </div>
        {%endif%}

        <div>
            {%if party.members.count%}
            <div>สมาชิก</div>
                {%for member in party.members.all %}
                <div>
                    <a href="#">{{member}}</a>
                </div>
            
                {%endfor%}
            {%endif%}
        </div>
    </div>

  

<div class="lg:w-2/4 mx-4 lg:mx-auto p-4 bg-white rounded-xl">
    <div class="chat-messages space-y-3 " id="chat-messages">
        
           
            {%for message in messages%}
            <div class="p-4 bg-gray-200 rounded-xl">
                <p class="font-semibold">{{message.user.username}}</p>
                <p class="font-semibold">{{message.message}}</p>
                <p class="font-semibold">{{message.timestamp}}</p>

                
             </div>  
            {%endfor%}
        
</div>
<div class="lg:w-2/4 mt-6 mx-4 lg:mx-auto p-4 bg-white rounded-xl">
    <form method="POST" class="flex" action=".">
        {%csrf_token%}
        <input type="text" name="content" class="flex-1 mr-3 " placeholder="Your message" id="chat-message-input">
        <button class="px-5 py-3 rounded-xl text-white bg-teal-600 hover:bg-teal-700" id="chat-message-submit">Send</button>

    </form>
</div>

{{request.user.username|json_script:"json-username"}}

{% block scripts %}{% endblock %}
<script>
    const party_id = {{party.id}};
    const userName = "{{request.user.username}}";
    const test = JSON.parse(document.getElementById('json-username').textContent);
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/party/' + party_id+'/');
    
   

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.message) {
            let html = '<div class="p-4 bg-gray-200 rounded-xl">';
            html += '<p class="font-semibold">' + data.username + ':</p>'
            html += '<p class="font-semibold">' + data.message + '</p></div>';

            document.querySelector('#chat-messages').innerHTML += html;
        }
    }

    chatSocket.onclose = function(e) {
        console.log('Connection closed');
    }

    document.querySelector('#chat-message-submit').onclick = function(e) {
        e.preventDefault();
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
       

        chatSocket.send(JSON.stringify({
            'message': message,
            'username':userName,
            'party': party_id,
        }));

        messageInputDom.value = '';
    }
</script>

</div>


{%else%}
<div  class="text-center" >ไม่สามารถดูรายละเอียดได้เนื่องจากปาร์ตี้ยังไม่ได้รับการอนุมัติ</div>
{%endif%}


{%endblock%}